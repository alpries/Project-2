#include "posix-calls.h"
#include "Llibc.h"
#include "Implt.h"

#define TOKEN_SIZE 100

int parseLine(char **line, int len, char **token);

/* Starts the Terminal*/

int 
getcmd(char *buf, int nbuf)
{
  Lwrite(2, "batcave$ ", 9);
  Lmemset(buf, 0, nbuf);
  Lgets(buf, nbuf);
  if(buf[0] == 0) // EOF
    return -1;
  return 0;
}

int
Lmain(int argc, char *argv[]){
 static char buf[100];
 char *ptrBuf;
 int fd;
 char *token[TOKEN_SIZE];

 // Check the file descriptor is open.
 while((fd = Lopen("console",0)) >= 0){
   if(fd >= 3){
    Lclose(fd);
    break;
   }
 }

 // Reads and Runs commands inputted.
 while(getcmd(buf, sizeof(buf)) >= 0){ // Reads input from the console starting from $
  if(buf[0] == 'c' && buf[1] == 'd' && buf[2] == ' '){ //Checks if its 'cd '
      // Chdir must be called by the parent, not the child.
      buf[Lstrlen(buf)-1] = 0;  // chop \n
     // if(chdir(buf+3) < 0)
     //   Lfprintf(2, "cannot cd %s\n", buf+3);
      continue;
    }

  if (buf[0] != ' '){
     ptrBuf = buf;
     // Parses Line to get the token
     parseLine(&ptrBuf, Lstrlen(buf),token);
     Lwrite(2, "batcave$ ", 9);
     // Loops through the Line token
     for(int j =0; j < 30; j++){
	// Makes sure the tokens arent null
       if(token[j] != NULL){
	 // Help Command was Called
	 if (Lstrcmp(token[j], "help") == 0){
	   Lprintf("Got here");
 	   help();
	   break;
	 }

         Lprintf(" %s", token[j]);
       }
     }
  }

  

 }
 return 1;
}

// Takes the Line command, as well as the size
int
parseLine(char **line, int len, char **token){
    int tokenPos = 0;
    int inToken = 0;
    
    for(int i = 0; i < len;i++){
        if((*line)[i] == '\n'){
            break;
        }
        
        if ((*line)[i] != ' '){
            if (inToken == 0){
		if (i > 0){
                  (*line)[i-1] = '\0';
		}
                token[tokenPos++] = &(*line)[i];
            }
            
            inToken = 1;
        }
        
        if ((*line)[i] == ' '){
            if (inToken == 1){
                 (*line)[i] = '\0';
            }
            inToken = 0;
        }
    }
    return 1;
}


